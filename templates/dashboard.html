{% extends 'layouts/base.html' %}

{% block title %}
{% if user_type == 'teacher' %}Teacher{% else %}Student{% endif %} Dashboard
{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 bg-light sidebar p-4">
      <h5 class="mb-4">Dashboard</h5>
      
      <div class="list-group mb-4">
        <a href="#" class="list-group-item list-group-item-action active">Home</a>
        <a href="/view-scenarios" class="list-group-item list-group-item-action">Explore Scenarios</a>
        
        {% if user_type == 'teacher' %}
        <!-- Teacher-specific sidebar items -->
        <a href="#" class="list-group-item list-group-item-action" onclick="showTeacherPanel('story-gallery')">Story Gallery</a>
        <a href="#" class="list-group-item list-group-item-action" onclick="showTeacherPanel('manage-assignments')">Manage Assignments</a>
        <a href="#" class="list-group-item list-group-item-action" onclick="showTeacherPanel('manage-classes')">Manage Classes</a>
        <a href="#" class="list-group-item list-group-item-action" onclick="showTeacherPanel('track-progress')">Track Progress</a>
        {% else %}
        <!-- Student-specific sidebar items -->
        <a href="#" class="list-group-item list-group-item-action" onclick="showStudentPanel('join-assignment')">Join Assignment</a>
        <a href="#" class="list-group-item list-group-item-action" onclick="showStudentPanel('my-assignments')">My Assignments</a>
        <a href="#" class="list-group-item list-group-item-action" onclick="showStudentPanel('join-class')">Join Class</a>
        <a href="#" class="list-group-item list-group-item-action" onclick="showStudentPanel('my-progress')">My Progress</a>
        {% endif %}
      </div>
      
      <div class="user-info mt-auto">
        <p class="mb-1"><strong>Welcome, {{ user.name }}</strong></p>
        <small class="text-muted">{{ 'Teacher' if user_type == 'teacher' else 'Student' }}</small>
      </div>
    </div>
    
    <!-- Main content -->
    <div class="col-md-9 col-lg-10 main-content p-4">
      <h1 class="mb-4">{% if user_type == 'teacher' %}Teacher{% else %}Student{% endif %} Dashboard</h1>
      
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Welcome, {{ user.name }}</h5>
          <p class="card-text">You are logged in as a {{ 'teacher' if user_type == 'teacher' else 'student' }}.</p>
        </div>
      </div>
      
      {% if user_type == 'teacher' %}
      <!-- Teacher-specific content -->
      <div id="teacher-home-panel">
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Your Classes</h5>
              </div>
              <div class="card-body">
                {% if user.classes %}
                  <div class="list-group">
                    {% for class in user.classes %}
                      <div class="list-group-item">
                        <h5>{{ class.name }}</h5>
                        <p>{{ class.subject }}</p>
                        <small>{{ class.students|length }} students</small>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p>You don't have any classes yet.</p>
                  <a href="#" class="btn btn-primary" onclick="showTeacherPanel('manage-classes')">Create a class</a>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
              </div>
              <div class="card-body">
                <div class="d-grid gap-2">
                  <button class="btn btn-primary" onclick="showTeacherPanel('manage-assignments')">Create New Assignment</button>
                  <a href="/view-scenarios" class="btn btn-outline-primary">Explore Scenarios</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Teacher: Manage Assignments Panel -->
      <div id="manage-assignments-panel" class="panel" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Manage Assignments</h2>
          <button class="btn btn-outline-secondary" onclick="showTeacherPanel('home')">Back to Dashboard</button>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Create New Assignment</h5>
          </div>
          <div class="card-body">
            <form id="create-assignment-form">
              <div class="mb-3">
                <label for="assignment-title" class="form-label">Assignment Title</label>
                <input type="text" class="form-control" id="assignment-title" placeholder="Apollo 11 Mission" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Scenario</label>
                <p class="form-text">Currently using: <strong>Apollo 11</strong></p>
              </div>
              <div class="mb-3">
                <label for="assignment-class" class="form-label">Assign to Class (Optional)</label>
                <select class="form-select" id="assignment-class">
                  <option value="">None</option>
                  {% if user.classes %}
                    {% for class in user.classes %}
                      <option value="{{ class.id }}">{{ class.name }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Create Assignment</button>
            </form>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Your Assignments</h5>
          </div>
          <div class="card-body">
            <div id="assignments-list">
              <p class="text-center text-muted">Loading assignments...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Teacher: Assignment Details Panel (initially hidden, shown when an assignment is clicked) -->
      <div id="assignment-details-panel" class="panel" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Assignment Details</h2>
          <button class="btn btn-outline-secondary" onclick="showTeacherPanel('manage-assignments')">Back to Assignments</button>
        </div>
        
        <div id="assignment-details-content">
          <!-- Content will be populated dynamically -->
        </div>
      </div>
      
      <!-- Other teacher panels (initially hidden) -->
      <div id="story-gallery-panel" class="panel" style="display: none;">
        <h2>Story Gallery</h2>
        <p>Create and manage historical scenarios for your students.</p>
      </div>
      
      <div id="manage-classes-panel" class="panel" style="display: none;">
        <h2>Manage Classes</h2>
        <p>Create and manage your classes.</p>
      </div>
      
      <div id="track-progress-panel" class="panel" style="display: none;">
        <h2>Track Progress</h2>
        <p>Monitor your students' progress on assignments.</p>
      </div>
      
      {% else %}
      <!-- Student-specific content -->
      <div id="student-home-panel">
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Your Classes</h5>
              </div>
              <div class="card-body">
                {% if user.classes %}
                  <div class="list-group">
                    {% for class in user.classes %}
                      <div class="list-group-item">
                        <h5>{{ class.name }}</h5>
                        <p>{{ class.subject }}</p>
                        <small>Teacher: {{ class.teacher.name }}</small>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p>You're not enrolled in any classes yet.</p>
                  <a href="#" class="btn btn-primary" onclick="showStudentPanel('join-class')">Join a class</a>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
              </div>
              <div class="card-body">
                <div class="d-grid gap-2">
                  <button class="btn btn-primary" onclick="showStudentPanel('join-assignment')">Join Assignment</button>
                  <a href="/view-scenarios" class="btn btn-outline-primary">Explore Scenarios</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Student: Join Assignment Panel -->
      <div id="join-assignment-panel" class="panel" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Join Assignment</h2>
          <button class="btn btn-outline-secondary" onclick="showStudentPanel('home')">Back to Dashboard</button>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Enter Assignment Code</h5>
          </div>
          <div class="card-body">
            <form id="join-assignment-form">
              <div class="mb-3">
                <label for="assignment-code" class="form-label">Assignment Code</label>
                <input type="text" class="form-control" id="assignment-code" placeholder="Enter the 6-digit code from your teacher" maxlength="6" required>
                <div class="form-text">Your teacher will provide you with a 6-digit code to join the assignment.</div>
              </div>
              <button type="submit" class="btn btn-primary">Join Assignment</button>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Student: My Assignments Panel -->
      <div id="my-assignments-panel" class="panel" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>My Assignments</h2>
          <button class="btn btn-outline-secondary" onclick="showStudentPanel('home')">Back to Dashboard</button>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Your Assignments</h5>
          </div>
          <div class="card-body">
            <div id="student-assignments-list">
              <p class="text-center text-muted">Loading assignments...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Other student panels (initially hidden) -->
      <div id="join-class-panel" class="panel" style="display: none;">
        <h2>Join Class</h2>
        <p>Join a class using a class code from your teacher.</p>
      </div>
      
      <div id="my-progress-panel" class="panel" style="display: none;">
        <h2>My Progress</h2>
        <p>Track your progress on assignments.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .sidebar {
    min-height: calc(100vh - 120px);
    display: flex;
    flex-direction: column;
  }
  
  .main-content {
    min-height: calc(100vh - 120px);
  }
  
  @media (max-width: 768px) {
    .sidebar {
      min-height: auto;
      margin-bottom: 20px;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Teacher panel navigation
  function showTeacherPanel(panelId) {
    // Hide all panels
    document.querySelectorAll('.panel').forEach(panel => {
      panel.style.display = 'none';
    });
    
    // Show the selected panel
    if (panelId === 'home') {
      document.getElementById('teacher-home-panel').style.display = 'block';
    } else {
      document.getElementById(`${panelId}-panel`).style.display = 'block';
    }
    
    // If showing assignments panel, load assignments
    if (panelId === 'manage-assignments') {
      loadTeacherAssignments();
    }
  }
  
  // Student panel navigation
  function showStudentPanel(panelId) {
    // Hide all panels
    document.querySelectorAll('.panel').forEach(panel => {
      panel.style.display = 'none';
    });
    
    // Show the selected panel
    if (panelId === 'home') {
      document.getElementById('student-home-panel').style.display = 'block';
    } else {
      document.getElementById(`${panelId}-panel`).style.display = 'block';
    }
    
    // If showing my assignments panel, load assignments
    if (panelId === 'my-assignments') {
      loadStudentAssignments();
    }
  }
  
  // Teacher: Load assignments
  function loadTeacherAssignments() {
    fetch('/api/assignments')
      .then(response => response.json())
      .then(data => {
        const assignmentsList = document.getElementById('assignments-list');
        
        if (data.assignments && data.assignments.length > 0) {
          let html = '<div class="list-group">';
          
          data.assignments.forEach(assignment => {
            const statusBadge = assignment.is_active 
              ? '<span class="badge bg-success">Active</span>' 
              : '<span class="badge bg-secondary">Inactive</span>';
              
            html += `
              <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mb-1">${assignment.title}</h5>
                  ${statusBadge}
                </div>
                <p class="mb-1">Scenario: ${assignment.scenario}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <small>Code: <strong>${assignment.access_code}</strong></small>
                  <small>${assignment.student_count} students enrolled</small>
                </div>
                <div class="mt-2">
                  <button class="btn btn-sm btn-outline-primary" onclick="viewAssignmentDetails(${assignment.id})">View Details</button>
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          assignmentsList.innerHTML = html;
        } else {
          assignmentsList.innerHTML = '<p class="text-center">No assignments created yet.</p>';
        }
      })
      .catch(error => {
        console.error('Error loading assignments:', error);
        document.getElementById('assignments-list').innerHTML = 
          '<div class="alert alert-danger">Error loading assignments. Please try again.</div>';
      });
  }
  
  // Student: Load assignments
  function loadStudentAssignments() {
    fetch('/api/student/assignments')
      .then(response => response.json())
      .then(data => {
        const assignmentsList = document.getElementById('student-assignments-list');
        
        if (data.assignments && data.assignments.length > 0) {
          let html = '<div class="list-group">';
          
          data.assignments.forEach(assignment => {
            const statusBadge = assignment.completed 
              ? '<span class="badge bg-success">Completed</span>' 
              : '<span class="badge bg-warning text-dark">In Progress</span>';
              
            html += `
              <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mb-1">${assignment.title}</h5>
                  ${statusBadge}
                </div>
                <p class="mb-1">Scenario: ${assignment.scenario}</p>
                <p class="mb-1">Teacher: ${assignment.teacher_name}</p>
                ${assignment.score ? `<p class="mb-1">Score: ${assignment.score}</p>` : ''}
                <div class="mt-2">
                  <a href="/view-scenarios" class="btn btn-sm btn-primary">Continue</a>
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          assignmentsList.innerHTML = html;
        } else {
          assignmentsList.innerHTML = '<p class="text-center">You haven\'t joined any assignments yet.</p>';
        }
      })
      .catch(error => {
        console.error('Error loading assignments:', error);
        document.getElementById('student-assignments-list').innerHTML = 
          '<div class="alert alert-danger">Error loading assignments. Please try again.</div>';
      });
  }
  
  // Teacher: View assignment details
  function viewAssignmentDetails(assignmentId) {
    fetch(`/api/assignments/${assignmentId}`)
      .then(response => response.json())
      .then(data => {
        const assignment = data.assignment;
        const detailsContent = document.getElementById('assignment-details-content');
        
        let html = `
          <div class="card mb-4">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">${assignment.title}</h5>
                <span class="badge ${assignment.is_active ? 'bg-success' : 'bg-secondary'}">
                  ${assignment.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
            </div>
            <div class="card-body">
              <p><strong>Scenario:</strong> ${assignment.scenario}</p>
              <p><strong>Access Code:</strong> <span class="badge bg-primary">${assignment.access_code}</span></p>
              <p><strong>Created:</strong> ${new Date(assignment.created_at).toLocaleString()}</p>
              ${assignment.class_name ? `<p><strong>Class:</strong> ${assignment.class_name}</p>` : ''}
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Student Progress</h5>
            </div>
            <div class="card-body">
        `;
        
        if (assignment.students && assignment.students.length > 0) {
          html += `
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Status</th>
                    <th>Score</th>
                    <th>Last Updated</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          assignment.students.forEach(student => {
            html += `
              <tr>
                <td>${student.name}</td>
                <td>
                  <span class="badge ${student.completed ? 'bg-success' : 'bg-warning text-dark'}">
                    ${student.completed ? 'Completed' : 'In Progress'}
                  </span>
                </td>
                <td>${student.score || 'N/A'}</td>
                <td>${new Date(student.last_updated).toLocaleString()}</td>
              </tr>
            `;
          });
          
          html += `
                </tbody>
              </table>
            </div>
          `;
        } else {
          html += '<p class="text-center">No students have joined this assignment yet.</p>';
        }
        
        html += `
            </div>
          </div>
        `;
        
        detailsContent.innerHTML = html;
        showTeacherPanel('assignment-details');
      })
      .catch(error => {
        console.error('Error loading assignment details:', error);
        alert('Error loading assignment details. Please try again.');
      });
  }
  
  // Add event listeners when the page loads
  document.addEventListener('DOMContentLoaded', function() {
    // Teacher: Create assignment form submission
    const createAssignmentForm = document.getElementById('create-assignment-form');
    if (createAssignmentForm) {
      createAssignmentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const title = document.getElementById('assignment-title').value;
        const classId = document.getElementById('assignment-class').value;
        
        fetch('/api/assignments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title: title,
            class_id: classId || null
          }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`Assignment created successfully! Access code: ${data.assignment.access_code}`);
            createAssignmentForm.reset();
            loadTeacherAssignments();
          } else {
            alert(data.message || 'Error creating assignment');
          }
        })
        .catch(error => {
          console.error('Error creating assignment:', error);
          alert('Error creating assignment. Please try again.');
        });
      });
    }
    
    // Student: Join assignment form submission
    const joinAssignmentForm = document.getElementById('join-assignment-form');
    if (joinAssignmentForm) {
      joinAssignmentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const accessCode = document.getElementById('assignment-code').value.toUpperCase();
        
        fetch('/api/join-assignment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            access_code: accessCode
          }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`Successfully joined assignment: ${data.assignment.title}`);
            joinAssignmentForm.reset();
            window.location.href = '/view-scenarios'; // Redirect to start the scenario
          } else {
            alert(data.error || 'Error joining assignment');
          }
        })
        .catch(error => {
          console.error('Error joining assignment:', error);
          alert('Error joining assignment. Please try again.');
        });
      });
    }
  });
</script>
{% endblock %} 